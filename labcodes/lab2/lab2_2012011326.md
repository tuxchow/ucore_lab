#Lab2 Report

##练习1
---
1.实现 first-fit 连续物理内存分配算法的设计思路

>	由于之前做spoc练习的时候写过一题first-fit内存分配算法，所以这次直接照搬上次写算法时的思路，简要说明下设计思路：分配时直接从链表头开始遍历到内存空间大于所需空间的第一个内存块，分配内存将其从链表中删除，如果内存块的大小大于所需空间则将剩余空间分割出新的内存块加入链表；回收时直接修改内存块标记，再将其加入到链表原位置，然后搜索其前后的内存块是否空闲，若空闲则合并成更大的块。

>	代码方面，由于default_pmm.c中的代码框架较为完整，所以我并没有对其进行大的改动，只是按照注释，将其中加入链表的函数list_add改为list_add_before，之后在default_alloc_pages函数中，加入了一句SetPageProperty(p),代码见下。由于是按照代码框架自己修改而成，故与标准答案代码有很大区别。

```
static struct Page *
default_alloc_pages(size_t n) {
    assert(n > 0);
    if (n > nr_free) {
        return NULL;
    }
    struct Page *page = NULL;
    list_entry_t *le = &free_list;
    while ((le = list_next(le)) != &free_list) {
        struct Page *p = le2page(le, page_link);
        if (p->property >= n) {
            page = p;
            break;
        }
    }
    if (page != NULL) {
        list_del(&(page->page_link));
        if (page->property > n) {
            struct Page *p = page + n;
            p->property = page->property - n;
            SetPageProperty(p);
            list_add_before(&free_list, &(p->page_link));
    }
        nr_free -= n;
        ClearPageProperty(page);
    }
    return page;
}
```



2.你的first fit算法是否有进一步的改进空间？

>	有，比如在default_free_pages函数中，在合并相邻的空闲内存块时，框架程序用的方法是从链表头开始遍历整个链表，将释放块与相邻的空闲块合并，这种遍历整个链表的方法是极其浪费资源的。改进方法有直接以释放块的内存地址为坐标向上向下寻找最近相邻块，如其空闲则合并。

##练习2
---
1.实现寻找虚拟地址对应的页表项设计思路

>	大致思路是首先按照pgdir和虚拟地址找到页表对应的页目录项，然后判断是否在内存中，如不在则根据需要创建页表，并将页表的引用加1，将页表对应的页目录项置标志位，最后返回虚拟地址对应的页表项。
>	
>	代码方面按照注释写出，除代码风格外，功能与标准答案基本相同。	
2.请描述页目录项（Pag Director Entry）和页表（Page Table Entry）中每个组成部分的含义和以及对ucore而言的潜在用处

>	这两项都由两部分构成，一是标志位，二是表项。标志位的功能是记录控制信息，如是否在内存中，是否有写权限等等，而表项则记录有内容，页目录项记录的是二级页表所在的物理地址，二级页表项记录的是页的物理地址。潜在用处是可以方便的进行内存以及权限管理。

3.如果ucore执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？

>	触发异常，进入异常处理程序，如果是访问权限不足，则报错，如果是缺页异常，则需要将页表从硬盘中调入内存中（如果此时内存已满，还需将根据页替换策略将页换出到硬盘），最后跳会异常指令处并恢复现场。



##练习3
---
1.释放某虚地址所在的页并取消对应二级页表项的映射设计思路

>	首先判断是否该二级表项在内存中，如在则将其对应页的引用减1，如减至0则释放该页，最后将表项清空，并将其在tlb中的对应项置为无效。
>	
>	代码方面按照注释写出，除代码风格外，功能与标准答案基本相同。

2.数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？

>	有。页目录项记录的二级页表就在Page的全局变量中，而二级页表项记录的物理页帧也在Page的全局变量中，所以存在对应关系。

3.如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？ 鼓励通过编程来具体完成这个问题

>	减去 KERNBASE = 0xC0000000 即可。